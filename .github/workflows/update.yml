name: Update CIDR List

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate CIDR files
        run: |
          rm -f CIDR*
          curl -s "https://core.telegram.org/resources/cidr.txt" | sed "s/[[:space:]]//g" > CIDR.txt
          cp CIDR.txt CIDR.conf && sed -i "s|^|IP-CIDR,|g" CIDR.conf
          cp CIDR.txt CIDR.yaml && sed -i -e "s|^|  - '&|g" -e "s|$|&'|g" -e "1s|^|payload:\n|" CIDR.yaml

          grep -v ":" CIDR.txt > CIDRv4.txt && grep -v ":" CIDR.conf > CIDRv4.conf
          grep -v ":" CIDR.yaml | sed "1s|^|payload:\n|" > CIDRv4.yaml

          grep ":" CIDR.txt > CIDRv6.txt && grep ":" CIDR.conf > CIDRv6.conf
          grep ":" CIDR.yaml > CIDRv6.yaml

          DATE=$(date --rfc-3339=seconds)
          sed -i '$ d' README.md
          echo "*The last check was conducted at $DATE.*" >> README.md

      - name: Setup git
        uses: actions4git/setup-git@v1

      - name: Commit and Push Changes
        run: |
          git add .
          git commit --message "$(date --rfc-3339=seconds)"
          git push -f origin master
